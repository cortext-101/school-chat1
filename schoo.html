<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>School Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#1e1f22; color:white; }
header { background:#5865f2; padding:12px; text-align:center; font-size:22px; font-weight:bold; }
#container { display:flex; flex-direction:column; height:calc(100vh - 52px); }
#chatBox { flex:1; background:#2b2d31; padding:10px; overflow-y:auto; margin:10px; border-radius:8px; }
.msg { margin-bottom:6px; }
.me { color:#57f287; }
.them { color:#faa61a; }
#controls { display:flex; margin:10px; }
#controls input { flex:1; padding:10px; border-radius:5px; border:none; }
#controls button { margin-left:6px; padding:10px; border:none; border-radius:5px; background:#5865f2; color:white; cursor:pointer; }
#videoControls { display:flex; margin:10px; }
#videoControls button { margin-right:6px; padding:10px; border:none; border-radius:5px; background:#5865f2; color:white; cursor:pointer; }
#videoContainer { display:flex; flex-wrap:wrap; margin:10px; gap:10px; }
video { width:48%; border-radius:8px; background:black; }
@media(max-width:700px){ video{width:100%;} }
</style>
</head>
<body>

<header>School Chat</header>

<div id="container">
  <div id="chatBox"></div>
  <div id="controls">
    <input id="username" placeholder="Your name">
    <input id="message" placeholder="Type message">
    <button onclick="sendMessage()">Send</button>
  </div>
  <div id="videoControls">
    <button onclick="startVideo()">Start My Video</button>
  </div>
  <div id="videoContainer">
    <video id="myVideo" autoplay muted></video>
  </div>
</div>

<script>
//// --- Supabase Setup --- ///
const SUPABASE_URL = 'supabase.com/jmdjuxgyuurvzblueusg';
const SUPABASE_KEY = 'sb_publishable_jQ1UrqmnMs-UTqwObWVfYg_t8zFAmd4';
const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Listen to new messages
async function subscribeMessages(){
  const { data } = await supabase
    .from('messages')
    .select('*')
    .order('created_at', { ascending:true });
  data.forEach(d=>addMessage(`${d.username}: ${d.message}`, 'them'));

  supabase
    .from('messages')
    .on('INSERT', payload => {
      const msg = payload.new;
      addMessage(`${msg.username}: ${msg.message}`, 'them');
    }).subscribe();
}

// Send a message
async function sendMessage(){
  const username = document.getElementById('username').value || 'User';
  const message = document.getElementById('message').value.trim();
  if(!message) return;
  await supabase.from('messages').insert([{ username, message }]);
  addMessage(`Me: ${message}`, 'me');
  document.getElementById('message').value='';
}

// Display message in chat box
function addMessage(text, cls){
  const div = document.createElement('div');
  div.className = 'msg '+cls;
  div.innerText = text;
  document.getElementById('chatBox').appendChild(div);
  document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
}

subscribeMessages();

//// --- PeerJS Video Setup --- ///
let peer;
let localStream;
let videoCalls = {};

peer = new Peer(Math.floor(Math.random()*10000).toString(), {
  host:'0.peerjs.com',
  port:443,
  secure:true
});

peer.on('open', id => addMessage('Your Peer ID: '+id,'me'));

// Handle incoming calls
peer.on('call', call=>{
  if(localStream){
    call.answer(localStream);
  }
  call.on('stream', addVideo);
});

// Start local video and auto call known peers (optional: paste Peer IDs in console to test small groups)
async function startVideo(){
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  document.getElementById('myVideo').srcObject = localStream;
  addMessage('Video started. Share your Peer ID with friends for video calls.','me');
}

// Add remote video
function addVideo(stream){
  const v=document.createElement('video');
  v.srcObject = stream;
  v.autoplay=true;
  document.getElementById('videoContainer').appendChild(v);
}
</script>

</body>
</html>
